# SQLModel Database Setup Template
# Production-ready database configuration with connection pooling

from collections.abc import Generator
from contextlib import asynccontextmanager

from fastapi import FastAPI
from sqlmodel import Session, SQLModel, create_engine
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession

from app.config import settings


# =============================================================================
# Synchronous Engine (psycopg2, pymysql, sqlite)
# =============================================================================

engine = create_engine(
    settings.DATABASE_URL,

    # Connection pooling
    pool_size=20,              # Persistent connections
    max_overflow=10,           # Temporary connections above pool_size
    pool_timeout=30,           # Wait time for connection (seconds)
    pool_recycle=1800,         # Recycle connections after 30 minutes
    pool_pre_ping=True,        # Test connection before checkout

    # Debugging (disable in production)
    echo=settings.DEBUG,
)


def get_session() -> Generator[Session, None, None]:
    """FastAPI dependency for database session."""
    with Session(engine) as session:
        yield session


# =============================================================================
# Async Engine (asyncpg, aiomysql, aiosqlite)
# =============================================================================

async_engine = create_async_engine(
    settings.ASYNC_DATABASE_URL,

    # Connection pooling
    pool_size=20,
    max_overflow=10,
    pool_pre_ping=True,
    pool_recycle=1800,

    # Debugging
    echo=settings.DEBUG,
)

async_session_factory = async_sessionmaker(
    async_engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autocommit=False,
    autoflush=False,
)


async def get_async_session() -> AsyncSession:
    """FastAPI dependency for async database session."""
    async with async_session_factory() as session:
        yield session


# =============================================================================
# Lifecycle Management
# =============================================================================

def create_db_and_tables():
    """Create all tables. Use only in development."""
    SQLModel.metadata.create_all(engine)


async def create_db_and_tables_async():
    """Create all tables asynchronously."""
    async with async_engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.create_all)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """FastAPI lifespan manager for startup/shutdown."""
    # Startup
    if settings.DEBUG:
        await create_db_and_tables_async()

    yield

    # Shutdown
    await async_engine.dispose()


# =============================================================================
# Usage in main.py
# =============================================================================
#
# from fastapi import FastAPI
# from app.database import lifespan
#
# app = FastAPI(lifespan=lifespan)
